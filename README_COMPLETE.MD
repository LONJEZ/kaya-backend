# üöÄ Phase 6: Launch Readiness - Implementation Guide

## Quick Start

### 1. Install Phase 6
```bash
chmod +x install_phase6.sh
./install_phase6.sh
```

### 2. Configure Environment
```bash
# Edit .env file
nano .env

# Required variables:
GCP_PROJECT_ID=your-project-id
GOOGLE_APPLICATION_CREDENTIALS=/path/to/credentials.json
JWT_SECRET_KEY=your-secret-key-here
```

### 3. Start Server
```bash
# Activate venv
source venv/bin/activate

# Start server
uvicorn app.main:app --reload --port 8000
```

### 4. Test Phase 6
```bash
# Run Phase 6 tests
chmod +x test_phase6.sh
./test_phase6.sh

# Or run demo
chmod +x demo_phase6.sh
./demo_phase6.sh
```

---

## üÜï What's New in Phase 6

### 1. Advanced Observability
- **Structured JSON Logging**: Production-grade logs
- **Request Tracing**: Track requests with unique IDs
- **Performance Metrics**: Detailed timing data
- **Error Tracking**: Comprehensive error monitoring

### 2. Feature Flags
- **Gradual Rollout**: Enable features per user
- **A/B Testing**: Test features safely
- **Kill Switch**: Disable features instantly
- **API Control**: Manage via admin endpoints

### 3. Data Quality Monitoring
- **Duplicate Detection**: Find duplicate transactions
- **Missing Data Checks**: Validate completeness
- **Outlier Detection**: Identify anomalies
- **Freshness Checks**: Monitor data recency
- **Consistency Validation**: Ensure integrity

### 4. Admin APIs
- **System Stats**: Comprehensive metrics
- **Error Dashboard**: Recent errors
- **Cache Warming**: Pre-load queries
- **Maintenance Mode**: Graceful degradation

### 5. Launch Automation
- **Pre-Launch Checklist**: Automated validation
- **Launch Script**: One-command deployment
- **Health Monitoring**: Continuous checks
- **Rollback Support**: Quick recovery

---

## üìä New Endpoints

### Monitoring (`/api/monitoring`)
```bash
GET /health/detailed     # Detailed health check
GET /health/readiness    # K8s readiness probe
GET /health/liveness     # K8s liveness probe
GET /metrics            # Application metrics
```

### Admin (`/api/admin`)
```bash
GET  /system/stats                      # System statistics
POST /feature-flags/{feature}/enable    # Enable feature
POST /feature-flags/{feature}/disable   # Disable feature
GET  /errors/recent                     # Recent errors
POST /cache/warm                        # Warm cache
POST /maintenance/mode                  # Toggle maintenance
```

### Data Quality (`/api/data-quality`)
```bash
GET /check              # Run quality checks
```

---

## üß™ Testing Phase 6

### Automated Tests
```bash
# Run all Phase 6 tests
make test-phase6

# Or manually
./test_phase6.sh
```

### Manual Testing

**1. Test Monitoring:**
```bash
TOKEN=$(python3 -c "from app.auth import create_access_token; print(create_access_token({'sub': 'test'}))")

# Health check
curl http://localhost:8000/api/monitoring/health/detailed | jq

# Metrics
curl -H "Authorization: Bearer $TOKEN" \
  http://localhost:8000/api/monitoring/metrics | jq
```

**2. Test Admin APIs:**
```bash
# System stats
curl -H "Authorization: Bearer $TOKEN" \
  http://localhost:8000/api/admin/system/stats | jq

# Feature flags
curl -X POST -H "Authorization: Bearer $TOKEN" \
  http://localhost:8000/api/admin/feature-flags/ai_chat/disable

curl -X POST -H "Authorization: Bearer $TOKEN" \
  http://localhost:8000/api/admin/feature-flags/ai_chat/enable
```

**3. Test Data Quality:**
```bash
curl -H "Authorization: Bearer $TOKEN" \
  http://localhost:8000/api/data-quality/check | jq
```

---

## üéõÔ∏è Feature Flags

### Available Features
- `ai_chat` - AI chat functionality
- `advanced_analytics` - Advanced analytics endpoints
- `websocket` - Real-time WebSocket updates
- `csv_upload` - CSV file uploads
- `sheets_connector` - Google Sheets integration
- `mpesa_connector` - M-Pesa integration

### Enable/Disable Features

**Globally:**
```bash
# Disable for all users
curl -X POST -H "Authorization: Bearer $TOKEN" \
  http://localhost:8000/api/admin/feature-flags/ai_chat/disable

# Enable for all users
curl -X POST -H "Authorization: Bearer $TOKEN" \
  http://localhost:8000/api/admin/feature-flags/ai_chat/enable
```

**Per User:**
```bash
# Disable for specific user
curl -X POST -H "Authorization: Bearer $TOKEN" \
  "http://localhost:8000/api/admin/feature-flags/ai_chat/disable?user_id=user123"

# Enable for specific user
curl -X POST -H "Authorization: Bearer $TOKEN" \
  "http://localhost:8000/api/admin/feature-flags/ai_chat/enable?user_id=user123"
```

### Use in Code
```python
from app.services.feature_flags import feature_flags, Feature

# Check if feature is enabled
if feature_flags.is_enabled(Feature.AI_CHAT, user_id):
    # Use AI chat
    response = gemini_service.generate_response(...)
else:
    # Use fallback
    response = chat_fallback.generate_fallback_response(...)
```

---

## üìà Monitoring & Observability

### View System Stats
```bash
curl -H "Authorization: Bearer $TOKEN" \
  http://localhost:8000/api/admin/system/stats | jq
```

**Returns:**
- Request metrics
- Error counts
- Chat query stats
- Database statistics
- Feature flag status

### View Recent Errors
```bash
curl -H "Authorization: Bearer $TOKEN" \
  http://localhost:8000/api/admin/errors/recent?limit=10 | jq
```

### Structured Logging
```python
from app.services.observability import StructuredLogger

logger = StructuredLogger(__name__)

logger.info(
    "User action completed",
    user_id=user_id,
    action="query",
    duration_ms=123
)
```

**Log Output:**
```json
{
  "timestamp": "2025-10-20T12:00:00Z",
  "level": "INFO",
  "message": "User action completed",
  "request_id": "abc-123",
  "user_id": "user-001",
  "action": "query",
  "duration_ms": 123
}
```

---

## üîç Data Quality Checks

### Run Quality Check
```bash
curl -H "Authorization: Bearer $TOKEN" \
  http://localhost:8000/api/data-quality/check | jq
```

**Checks Performed:**
1. **Duplicates**: Finds duplicate transactions
2. **Missing Data**: Checks for null critical fields
3. **Outliers**: Statistical anomaly detection
4. **Freshness**: Verifies recent data
5. **Consistency**: Validates data integrity

**Example Response:**
```json
{
  "overall_status": "passed",
  "checks": {
    "duplicates": {
      "passed": true,
      "duplicate_count": 0,
      "message": "Found 0 potential duplicates"
    },
    "missing_data": {
      "passed": true,
      "missing_fields": {},
      "message": "No missing data"
    },
    "outliers": {
      "passed": true,
      "outlier_count": 2,
      "message": "Found 2 statistical outliers"
    },
    "freshness": {
      "passed": true,
      "days_since_last_update": 0,
      "message": "Latest data is 0 days old"
    }
  }
}
```

---

## üöÄ Pre-Launch Checklist

### Automated Checks
```bash
python3 scripts/pre_launch_checklist.py http://localhost:8000
```

**Validates:**
- ‚úÖ Health endpoints
- ‚úÖ API documentation
- ‚úÖ Authentication
- ‚úÖ Analytics endpoints
- ‚úÖ Chat endpoint
- ‚úÖ Rate limiting
- ‚úÖ Error handling
- ‚úÖ CORS configuration
- ‚úÖ Performance

### Manual Checklist
- [ ] Environment variables configured
- [ ] JWT secret in production
- [ ] BigQuery tables created
- [ ] Vertex AI enabled
- [ ] CORS origins updated
- [ ] Rate limits configured
- [ ] Monitoring dashboards ready
- [ ] Alerts configured
- [ ] Backup strategy defined
- [ ] Incident response plan ready

---

## üéØ Launch Process

### Option 1: Automated Launch
```bash
chmod +x launch.sh
./launch.sh
```

**Interactive script:**
1. Validates environment
2. Runs pre-launch checks
3. Builds Docker image
4. Deploys to chosen platform
5. Verifies deployment

### Option 2: Manual Steps

**Local:**
```bash
docker-compose -f docker-compose.prod.yml up -d
```

**Cloud Run:**
```bash
./deploy_cloud_run.sh
```

**Kubernetes:**
```bash
kubectl apply -f k8s/deployment.yaml
```

---

## üìä Production Monitoring

### Real-Time Metrics
```bash
# Watch metrics
watch -n 5 'curl -s -H "Authorization: Bearer $TOKEN" \
  http://localhost:8000/api/monitoring/metrics | jq'
```

### Cache Performance
```bash
# View cache stats
curl -H "Authorization: Bearer $TOKEN" \
  http://localhost:8000/api/cache/stats | jq

# Warm cache
curl -X POST -H "Authorization: Bearer $TOKEN" \
  http://localhost:8000/api/admin/cache/warm
```

### Health Monitoring
```bash
# Continuous health check
watch -n 10 'curl -s http://localhost:8000/api/monitoring/health/detailed | jq .status'
```

---

## üö® Incident Response

### Quick Diagnostics
```bash
# 1. Check health
curl http://localhost:8000/api/monitoring/health/detailed | jq

# 2. View recent errors
curl -H "Authorization: Bearer $TOKEN" \
  http://localhost:8000/api/admin/errors/recent?limit=10 | jq

# 3. System stats
curl -H "Authorization: Bearer $TOKEN" \
  http://localhost:8000/api/admin/system/stats | jq
```

### Emergency Actions

**Disable Problematic Feature:**
```bash
curl -X POST -H "Authorization: Bearer $TOKEN" \
  http://localhost:8000/api/admin/feature-flags/ai_chat/disable
```

**Clear Cache:**
```bash
curl -X POST -H "Authorization: Bearer $TOKEN" \
  http://localhost:8000/api/cache/clear
```

**Enable Maintenance Mode:**
```bash
curl -X POST -H "Authorization: Bearer $TOKEN" \
  "http://localhost:8000/api/admin/maintenance/mode?enabled=true"
```

---

## üìà Performance Benchmarks

### Expected Metrics
- Health check: < 50ms
- Monitoring endpoints: < 100ms
- Admin APIs: < 200ms
- Data quality checks: < 2s

### Run Benchmarks
```bash
# Benchmark all endpoints
python3 scripts/benchmark_complete.py
```

---

## üéì Best Practices

### 1. Monitoring
- Check metrics daily
- Set up alerts for errors
- Monitor cache hit rates
- Track response times

### 2. Feature Flags
- Test new features with small user groups
- Monitor impact after enabling
- Have rollback plan ready
- Document flag purposes

### 3. Data Quality
- Run quality checks weekly
- Address issues promptly
- Monitor freshness daily
- Track data volume trends

### 4. Incident Response
- Keep runbooks updated
- Practice rollback procedures
- Document incidents
- Review and improve processes

---

## ‚úÖ Phase 6 Complete Checklist

- [x] Structured logging implemented
- [x] Feature flags operational
- [x] Data quality checks active
- [x] Admin APIs deployed
- [x] Monitoring endpoints working
- [x] Pre-launch script ready
- [x] Launch automation complete
- [x] Documentation finished

---

## üéâ You're Ready to Launch!

Phase 6 adds enterprise-grade observability and control to your backend. You now have:

‚úÖ **Production Monitoring** - Real-time system visibility
‚úÖ **Feature Control** - Safe rollout capabilities  
‚úÖ **Data Quality** - Automated validation
‚úÖ **Admin Tools** - System management
‚úÖ **Launch Automation** - One-command deployment

**Run the demo to see it all in action:**
```bash
./demo_phase6.sh
```

**Deploy to production:**
```bash
./launch.sh
```

---

## üìû Support

- **API Docs**: http://localhost:8000/docs
- **Health Check**: http://localhost:8000/health
- **System Stats**: GET /api/admin/system/stats

**Your backend is now 100% production-ready! üöÄ**